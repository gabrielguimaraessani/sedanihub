# üöÄ Setup Firebase - Passo a Passo

Guia completo para configurar o Firebase Authentication e Firestore para o SedaniHub.

## üìã Checklist Geral

- [ ] Criar projeto no Firebase
- [ ] Configurar Authentication
- [ ] Criar primeiro usu√°rio
- [ ] Configurar Firestore Database
- [ ] Fazer deploy das regras de seguran√ßa
- [ ] Criar √≠ndices
- [ ] Configurar TTL
- [ ] Testar conex√£o no app

---

## 1Ô∏è‚É£ Criar Projeto Firebase

### No Firebase Console

1. Acesse https://console.firebase.google.com
2. Clique em **"Adicionar projeto"** ou **"Create a project"**
3. Preencha:
   - **Nome do projeto**: `sedanihub` (ou seu nome preferido)
   - **Google Analytics**: Desabilitar (opcional para app corporativo)
4. Clique em **"Criar projeto"**
5. Aguarde a cria√ß√£o (~1-2 minutos)

---

## 2Ô∏è‚É£ Configurar Authentication

### 2.1. Habilitar Email/Password

1. No Console do projeto, v√° em **Authentication**
2. Clique em **"Come√ßar"** ou **"Get started"**
3. V√° na aba **"Sign-in method"**
4. Clique em **"Email/Password"**
5. Habilite **"Email/Password"** (primeira op√ß√£o)
6. **N√ÉO** habilite "Email link" (segunda op√ß√£o)
7. Clique em **"Salvar"**

### 2.2. Criar Primeiro Usu√°rio (VOC√ä)

Na aba **"Users"**:

1. Clique em **"Adicionar usu√°rio"** / **"Add user"**
2. Preencha:
   - **Email**: `seu.email@sani.med.br`
   - **Senha**: Escolha uma senha forte (m√≠n. 6 caracteres)
   - **User ID**: Ser√° gerado automaticamente
3. Clique em **"Adicionar usu√°rio"**

‚úÖ **Este √© o usu√°rio que voc√™ usar√° para fazer login no app!**

### 2.3. Configurar Dom√≠nios Autorizados (Importante para Web)

1. Authentication ‚Üí **Settings** ‚Üí **Authorized domains**
2. J√° deve ter:
   - `localhost` (para desenvolvimento)
   - `seu-projeto.firebaseapp.com`
   - `seu-projeto.web.app`
3. Se for hospedar em dom√≠nio pr√≥prio, adicionar aqui

---

## 3Ô∏è‚É£ Configurar Firestore Database

### 3.1. Criar Database

1. No Console, v√° em **Firestore Database**
2. Clique em **"Criar banco de dados"** / **"Create database"**
3. Escolha:
   - **Modo**: **Produ√ß√£o** (Production mode)
   - **Localiza√ß√£o**: **southamerica-east1 (S√£o Paulo)** ‚≠ê Recomendado
   - Ou: **us-central1** (mais barato, mas mais longe)
4. Clique em **"Ativar"**

### 3.2. Collections Necess√°rias

O Firestore criar√° as collections automaticamente quando voc√™ usar o app. Mas voc√™ pode pr√©-criar:

**Collections principais:**
- `usuarios` (usu√°rios do sistema)
- `pacientes` (dados de pacientes)
- `medicos` (cadastro de m√©dicos)
- `servicos` (procedimentos/cirurgias)
- `plantoes` (escala de plant√µes)
- `notificacoes` (sistema de notifica√ß√µes)
- `filas_solicitacoes` (filas de banheiro/alimenta√ß√£o)
- `chat_plantao` (chat do plant√£o)

**Collections de cat√°logo:**
- `especialidades`
- `procedimentos`
- `complicacoes`
- `habitos`
- `medicamentosCatalogo`

---

## 4Ô∏è‚É£ Deploy das Regras de Seguran√ßa

### Op√ß√£o 1: Via Firebase CLI (Recomendado)

```bash
# 1. Fazer login (se ainda n√£o fez)
firebase login

# 2. Inicializar projeto (se ainda n√£o fez)
cd D:\flutter\sanihub
firebase init firestore

# Selecionar:
# - Use existing project ‚Üí Seu projeto
# - Firestore rules: security/firestore.rules
# - Firestore indexes: firestore.indexes.json (criar se solicitado)

# 3. Fazer deploy
firebase deploy --only firestore:rules
```

### Op√ß√£o 2: Via Console (Manual)

1. Firebase Console ‚Üí **Firestore Database** ‚Üí **Regras**
2. Copiar todo o conte√∫do de `security/firestore.rules`
3. Colar no editor de regras
4. Clicar em **"Publicar"**

### Verificar Deploy

Ap√≥s deploy, voc√™ deve ver no console:
```
‚úî  Deploy complete!
```

---

## 5Ô∏è‚É£ Criar √çndices Compostos

### M√©todo 1: Autom√°tico (Mais F√°cil)

1. Execute o app
2. Navegue pelas funcionalidades
3. Quando aparecer erro de "√≠ndice necess√°rio", haver√° um **link clic√°vel**
4. Clique no link ‚Üí Firebase cria o √≠ndice automaticamente
5. Aguarde 2-3 minutos para √≠ndice ficar pronto
6. Recarregue o app

### M√©todo 2: Manual (Console)

Firebase Console ‚Üí **Firestore Database** ‚Üí **√çndices** ‚Üí **Criar √≠ndice**

**Criar estes √≠ndices priorit√°rios:**

#### √çndice 1: Notifica√ß√µes
- Collection: `notificacoes`
- Campos:
  1. `ativa` - Ascending
  2. `usuarioId` - Ascending  
  3. `dataCriacao` - Descending

#### √çndice 2: Filas
- Collection: `filas_solicitacoes`
- Campos:
  1. `concluida` - Ascending
  2. `dataExpiracao` - Ascending
  3. `dataSolicitacao` - Ascending

#### √çndice 3: Chat
- Collection: `chat_plantao`
- Campos:
  1. `plantaoData` - Ascending
  2. `dataEnvio` - Ascending

#### √çndice 4: Servi√ßos
- Collection: `servicos`
- Campos:
  1. `inicio` - Ascending
  2. `finalizado` - Ascending

**Lista completa em**: `security/firestore_indexes.md`

---

## 6Ô∏è‚É£ Configurar TTL (Time-to-Live)

### Para Mensagens do Chat (Auto-deletar ap√≥s 24h)

Firebase Console ‚Üí **Firestore Database** ‚Üí ‚öôÔ∏è **Configura√ß√µes** ‚Üí **Time-to-live**

1. Clicar em **"Criar pol√≠tica"** / **"Create policy"**
2. Preencher:
   - **Policy name**: `chat_plantao_cleanup`
   - **Collection**: `chat_plantao`
   - **Timestamp field**: `dataEnvio`
   - **Expiration**: `86400` (segundos = 24 horas)
3. Clicar em **"Criar"**

‚úÖ Agora mensagens do chat ser√£o automaticamente deletadas ap√≥s 24h!

---

## 7Ô∏è‚É£ Criar Documento de Usu√°rio no Firestore

### Importante: Sincronizar com Authentication

Quando criar usu√°rio no Authentication, criar tamb√©m documento em `/usuarios`:

1. Firestore Database ‚Üí Cole√ß√£o **"usuarios"**
2. **Adicionar documento**
3. **ID do documento**: `seu.email@sani.med.br` (mesmo email do Auth)
4. Campos:
```javascript
{
  nomeCompleto: "Seu Nome Completo",
  crmDf: 12345,
  email: "seu.email@sani.med.br",
  funcaoAtual: "Senior",
  gerencia: ["CEO"],
  dataCriacao: (timestamp atual),
  criadoPor: "system"
}
```

### Ou criar via script (futuro):

```dart
// Ap√≥s criar usu√°rio no Authentication
await FirebaseFirestore.instance
    .collection('usuarios')
    .doc(user.email)
    .set({
  'nomeCompleto': 'Nome do Usu√°rio',
  'email': user.email,
  'funcaoAtual': 'Senior',
  'dataCriacao': FieldValue.serverTimestamp(),
  'criadoPor': 'system',
});
```

---

## 8Ô∏è‚É£ Testar Conex√£o

### 8.1. No App

```bash
cd D:\flutter\sanihub
flutter clean
flutter pub get
flutter run -d chrome --web-port 52206
```

### 8.2. Fazer Login

1. App abre ‚Üí Tela de login
2. Digite:
   - **Email**: `seu.email@sani.med.br`
   - **Senha**: A senha que voc√™ criou no Firebase
3. Clicar em **"Entrar"**

### 8.3. O que Deve Acontecer

‚úÖ **Se der certo:**
- Login bem-sucedido
- Redirecionado para Dashboard
- Console mostra: `üéâ Login bem-sucedido: seu.email@sani.med.br`

‚ùå **Se der erro:**
- Verificar se usu√°rio foi criado no Authentication
- Verificar se email/senha est√£o corretos
- Ver logs no console do navegador (F12)

---

## 9Ô∏è‚É£ Verificar no Firebase Console

### Authentication ‚Üí Users

Deve mostrar:
- ‚úÖ Seu usu√°rio criado
- ‚úÖ √öltimo login (ap√≥s voc√™ fazer login no app)

### Firestore Database ‚Üí Data

Ap√≥s usar o app, deve mostrar:
- ‚úÖ Collection `usuarios` com seu documento
- ‚úÖ Collections criadas conforme uso (notificacoes, chat_plantao, etc)

### Firestore Database ‚Üí Regras

Deve mostrar:
- ‚úÖ Regras customizadas (n√£o as padr√µes)
- ‚úÖ √öltima publica√ß√£o: hoje

### Firestore Database ‚Üí √çndices

Conforme voc√™ usar o app, √≠ndices aparecer√£o aqui.

---

## üéØ Resumo R√°pido

### O que PRECISA fazer no Console:

1. ‚úÖ **Criar projeto**
2. ‚úÖ **Authentication** ‚Üí Habilitar Email/Password
3. ‚úÖ **Authentication** ‚Üí Criar seu usu√°rio
4. ‚úÖ **Firestore** ‚Üí Criar database (modo produ√ß√£o)
5. ‚úÖ **Firestore** ‚Üí Deploy das regras (via CLI ou manual)
6. ‚úÖ **Firestore** ‚Üí Configurar TTL para chat (opcional mas recomendado)
7. ‚úÖ **Firestore** ‚Üí Criar documento em `/usuarios/{seu.email}`

### O que √© AUTOM√ÅTICO:

- ‚úÖ Collections criadas conforme uso
- ‚úÖ √çndices sugeridos via links (clicar quando aparecer)
- ‚úÖ Cache configurado no c√≥digo
- ‚úÖ Limpeza de cache ao logout

---

## üîß Configura√ß√£o via CLI (M√©todo Completo)

Se preferir fazer tudo via terminal:

```bash
# 1. Login
firebase login

# 2. Criar projeto (ou usar existente)
firebase projects:create sedanihub

# 3. Inicializar no diret√≥rio
cd D:\flutter\sanihub
firebase init

# Selecionar:
# - Firestore (regras e √≠ndices)
# - Authentication (opcional)
# - Storage (se usar)
# - Hosting (se hospedar web)

# 4. Configurar Flutter app
flutterfire configure

# 5. Deploy
firebase deploy
```

---

## ‚ùì FAQ

### Preciso configurar algo no c√≥digo do app?

**N√ÉO!** ‚úÖ O c√≥digo j√° est√° pronto com:
- Firebase Authentication integrado
- Firestore configurado com cache otimizado
- Regras de seguran√ßa prontas
- Toda a l√≥gica implementada

### O que muda do login fake para o real?

**NADA na UI!** ‚úÖ Apenas internamente:
- Antes: Simulava login
- Agora: Conecta no Firebase de verdade
- Mensagens de erro mais espec√≠ficas
- Dados reais salvos no Firestore

### Consigo testar sem criar usu√°rios?

**N√ÉO** ‚ùå Voc√™ precisa criar pelo menos 1 usu√°rio no Firebase Console para fazer login.

### Como adicionar mais usu√°rios?

**Via Console** (Manual):
- Authentication ‚Üí Users ‚Üí Add user

**Via Admin SDK** (Futuro):
- Criar fun√ß√£o de administra√ß√£o
- Permitir coordenador criar usu√°rios

### Preciso ir ao Console para tudo?

**Apenas configura√ß√£o inicial:**
- ‚úÖ Criar projeto (1 vez)
- ‚úÖ Habilitar Authentication (1 vez)
- ‚úÖ Criar database (1 vez)
- ‚úÖ Deploy de regras (1 vez, depois pode ser via CLI)
- ‚úÖ Criar primeiro usu√°rio (1 vez)

**Depois disso:**
- ‚úÖ Criar mais usu√°rios ‚Üí Via Console ou Admin SDK
- ‚úÖ Ver dados ‚Üí Via Console (read-only)
- ‚úÖ Monitorar ‚Üí Via Console
- ‚ùå Desenvolvimento ‚Üí Tudo no c√≥digo!

---

## üéØ Ordem Recomendada

### Passo 1: Firebase Console (15 minutos)
```
1. Criar projeto
2. Authentication ‚Üí Email/Password
3. Authentication ‚Üí Criar seu usu√°rio
4. Firestore ‚Üí Criar database (produ√ß√£o, S√£o Paulo)
5. Firestore ‚Üí Criar documento em /usuarios/{seu.email}
```

### Passo 2: Terminal (5 minutos)
```bash
firebase login
cd D:\flutter\sanihub
firebase init firestore
firebase deploy --only firestore:rules
```

### Passo 3: App (2 minutos)
```bash
flutter clean
flutter pub get
flutter run -d chrome --web-port 52206
```

### Passo 4: Testar (2 minutos)
```
1. Login com email/senha criados
2. Navegar pelo app
3. Criar √≠ndices ao aparecer erros (clicar nos links)
```

### Passo 5: Finalizar (5 minutos)
```
1. Configurar TTL no Console
2. Verificar todas as funcionalidades
3. Criar mais usu√°rios se necess√°rio
```

**Total**: ~30 minutos

---

## üìù Template: Documento de Usu√°rio

Sempre que criar um usu√°rio no Authentication, criar este documento no Firestore:

### Collection: `/usuarios/{email@sani.med.br}`

```json
{
  "nomeCompleto": "Dr. Jo√£o Silva",
  "crmDf": 12345,
  "email": "joao.silva@sani.med.br",
  "funcaoAtual": "Senior",
  "gerencia": ["Nenhuma"],
  "dataCriacao": "2025-10-20T10:00:00Z",
  "criadoPor": "system",
  "ultimaModificacao": "2025-10-20T10:00:00Z",
  "modificadoPor": "system"
}
```

**Valores de `funcaoAtual`:**
- `Senior`
- `Pleno 2`
- `Pleno 1`
- `Assistente`
- `Analista de qualidade`
- `Administrativo`

**Valores de `gerencia`** (array):
- `Nenhuma`
- `CEO`
- `CFO`
- `COO`
- `Diretor de Qualidade`
- `Diretor de Marketing`
- (etc - ver `documentation/data/colecoes_sedanihub.md`)

---

## üîê Seguran√ßa

### Emails Permitidos

As regras s√≥ permitem:
- ‚úÖ `*@sani.med.br`
- ‚úÖ `*@sedanimed.br`

Outros dom√≠nios ser√£o **bloqueados** pelas regras de seguran√ßa.

### Custom Claims (Futuro)

Para adicionar roles (admin, medico, etc):

```javascript
// Via Firebase Admin SDK ou Cloud Functions
admin.auth().setCustomUserClaims(uid, {
  roles: ['medico', 'admin']
});
```

Por enquanto, todos os usu√°rios `@sani.med.br` t√™m acesso total.

---

## ‚úÖ Verifica√ß√£o Final

### No Firebase Console:

- [ ] Projeto criado
- [ ] Authentication habilitado
- [ ] Pelo menos 1 usu√°rio criado
- [ ] Firestore database criado
- [ ] Regras customizadas publicadas
- [ ] Documento em `/usuarios/{email}` criado

### No App:

- [ ] Consegue fazer login
- [ ] V√™ dashboard
- [ ] Notifica√ß√µes funcionam
- [ ] Chat do plant√£o acess√≠vel
- [ ] Filas funcionam
- [ ] Logout funciona

### Logs Esperados (Console do App):

```
‚úÖ Firestore configurado com cache otimizado
üì± Badge suportado: false (Web n√£o suporta)
üîê Tentativa de login iniciada para: seu.email@sani.med.br
‚úÖ Email v√°lido, autenticando no Firebase...
üéâ Login bem-sucedido: seu.email@sani.med.br
üß≠ Redirecionando para dashboard
```

---

## üÜò Problemas Comuns

### "Email inv√°lido" ao fazer login
- Verificar se email termina com `@sani.med.br`
- Verificar se digitou corretamente

### "Usu√°rio n√£o encontrado"
- Criar usu√°rio no Firebase Console ‚Üí Authentication ‚Üí Users

### "Erro de permiss√£o" ao acessar Firestore
- Verificar se regras foram deployed
- Verificar se email do usu√°rio √© `@sani.med.br`
- Ver regras em Firestore ‚Üí Regras

### "Query requires an index"
- Clicar no link fornecido no erro
- Ou criar √≠ndice manualmente no Console
- Aguardar 2-3 minutos

### App n√£o conecta ao Firebase
- Verificar arquivo `lib/firebase_options.dart` existe
- Executar: `flutterfire configure`
- Verificar conex√£o com internet

---

## üéâ Pronto!

Ap√≥s seguir todos os passos, seu app estar√°:

‚úÖ Conectado ao Firebase real  
‚úÖ Autentica√ß√£o funcionando  
‚úÖ Firestore configurado e seguro  
‚úÖ Cache otimizado  
‚úÖ Regras de seguran√ßa aplicadas  
‚úÖ LGPD compliant  

**Agora √© s√≥ usar!** üöÄ

